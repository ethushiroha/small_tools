
# -*- coding: utf-8 -*-

import requests
import json


# Whois 查询
class Whois:
    def __init__(self, res_json: dict = None):
        if res_json is None:
            return None
        if (res_json.get("code") != 0) or (res_json.get("data").get("status")) != 0:
            return None

        data = res_json.get("data").get("data")

        self.domain_name = str(data.get("domainName"))
        self.registor = str(data.get("registrant"))
        self.regist_time = str(data.get("registrationTime"))
        self.update_time = str(data.get("updatedDate"))
        self.email = str(data.get("contactEmail"))
        self.phone = str(data.get("contactPhone"))

    @staticmethod
    def get(url: str):
        api_url = "https://api.devopsclub.cn/api/whoisquery"
        data = {
            "domain": url,
            "type": "json",
            "standard": True
        }
        res = requests.post(api_url, data=data)
        if res.status_code == 200:
            res_json = json.loads(res.text)
            return Whois(res_json)

        else:
            print(res.status_code, res.text)
            return None

    def __str__(self):
        object_dict = {
            "域名": self.domain_name,
            "注册人": self.registor,
            "邮箱": self.email,
            "电话": self.phone,
            "注册时间": self.regist_time,
            "更新时间": self.update_time,
        }
        return to_str(object_dict)


# IP 归属地查询
class Ip2Addr:
    def __init__(self, res_json: dict = None):
        if res_json is None:
            return None
        if res_json.get("status") != "success":
            return None

        self.ip = res_json["ip"]
        self.country = res_json["country"]
        self.city = res_json["city"]
        self.org = res_json["org"]

    @staticmethod
    def get(ip: str) -> dict:
        try:
            # 太平洋 api
            api_url = "http://whois.pconline.com.cn/ipJson.jsp?ip={}&json=true".format(ip)
            res = requests.get(api_url)
            res_dict = {
                "ip": ip,
                "city": "",
                "country": "",
                "org": ""
            }
            if res.status_code == 200:
                res_json = json.loads(res.text)
                res_dict["status"] = "success"
                res_dict["ip"] = str(res_json["ip"])
                res_dict["city"] = str(res_json["addr"])

            # IP API
            api_url = "http://ip-api.com/json/{}?lang=zh-CN".format(ip)
            res = requests.get(api_url)
            if res.status_code == 200:
                res_json = json.loads(res.text)
                res_dict["status"] = "success"
                res_dict["country"] = str(res_json["country"])
                res_dict["org"] = str(res_json["org"])

            return Ip2Addr(res_dict)

        except Exception as e:
            print(e)
            return None

    def __str__(self):
        object_dict = {
            "ip": self.ip,
            "归属地": self.country + " " + self.city,
            "组织": self.org
        }
        return to_str(object_dict)


def to_str(object_dict: dict) -> str:
    if type(object_dict) is not dict:
        return None
    return json.dumps(object_dict, indent=4, sort_keys=True, ensure_ascii=False)
